@using FInalProject.ViewModels
@model BookFocusViewModel

@{
    ViewBag.Title = "Book Focus";
}

<!-- Include Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container mt-4">
    <h2 class="text-center">Book Details</h2>
    <hr />

    <div class="card p-4 shadow-sm position-relative">
        <div class="row g-0 align-items-center">
            <!-- Book Cover Image -->
            <div class="col-md-4 text-center">
                <img src="@Model.BookCover" class="img-fluid rounded" alt="Book Cover" style="width: 18rem; height: 18rem; object-fit: cover;">
            </div>

            <!-- Book Details -->
            <div class="col-md-8">
                <div class="card-body">
                    <!-- Like/Dislike Controls in the Top-Right -->
                    <div id="likeButton" class="position-absolute top-0 end-0 p-3 text-end">
                        <form asp-controller="BookOperations" asp-action="Rating" method="post" class="d-inline">
                            <input type="hidden" value="@Model.BookId" name="BookId" />
                            <input type="hidden" value="1" name="amount" />
                            <button type="submit" class="btn btn-outline-success btn-sm me-1" title="Upvote">
                                <i class="bi bi-hand-thumbs-up"></i>
                            </button>
                        </form>

                        <span class="fw-bold align-middle">
                            @(Model.Favourites?.Sum(x => x.Amount) ?? 0)
                        </span>

                        <form asp-controller="BookOperations" asp-action="Rating" method="post" class="d-inline">
                            <input type="hidden" value="@Model.BookId" name="BookId" />
                            <input type="hidden" value="-1" name="amount" />
                            <button type="submit" class="btn btn-outline-danger btn-sm ms-1" title="Downvote">
                                <i class="bi bi-hand-thumbs-down"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Main Content -->
                    <h3 class="card-title">@Model.BookName</h3>
                    <p class="card-text"><strong>Description:</strong> @Model.Description</p>
                    <p class="card-text"><strong>Author:</strong> @Model.BookAuthorName</p>
                    <p class="card-text"><strong>Reading Time:</strong> @Model.BookReadingTime</p>
                    <p class="card-text"><strong>Pages:</strong> @Model.BookPages</p>
                    <p class="card-text"><strong>Stock Left:</strong> @Model.AmountInStock</p>
                    <p class="card-text"><strong>Category:</strong> @Model.Category</p>

                    <!-- Display Genres -->
                    <p class="card-text">
                        <strong>Genres:</strong>
                        @if (!Model.genres.Any())
                        {
                            <span>No genres listed.</span>
                        }
                        else
                        {
                            @foreach (var genre in Model.genres)
                            {
                                <span class="badge bg-secondary">@genre.Name</span>
                            }
                        }
                    </p>

                    <!-- Admin Actions -->
                    @if (User.IsInRole("Admin"))
                    {
                        <a href="javascript:void(0)" onclick="DeleteBook(@Model.BookId)" class="btn btn-danger me-2">Delete</a>
                        <a href="@Url.Action("EditBook", "Books", new { editId = Model.BookId })" class="btn btn-primary">Edit</a>
                    }
                    else if (User.IsInRole("Librarian"))
                    {
                        <a href="@Url.Action("EditBook", "Books", new { editId = Model.BookId })" class="btn btn-primary">Edit</a>
                    }

                    @if (ViewBag.IsHe == true)
                    {
                        <a href="javascript:void(0)" onclick="BorrowBook(@Model.BookId)" class="btn btn-primary">Borrow</a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Section -->
    <div class="card mt-4 p-4 shadow-sm">
        <h3 class="mb-3">Comment Section</h3>
        <hr />

        <!-- Comment Form -->
        @await Html.PartialAsync("_CreateComment", new FInalProject.ViewModels.CreateCommentViewModel
   {
       BookId = Model.BookId
   })

        <hr />

        <!-- Comments Display -->
        @if (Model.comments == null || !Model.comments.Any())
        {
            <h4 class="text-muted">No comments yet</h4>
        }
        else
        {
            @foreach (var comment in Model.comments)
            {
                <div class="border-bottom py-3">
                    <h5 class="fw-bold">@comment.UserName</h5>
                    <p>@comment.Description</p>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script src="~/js/site.js"></script>
}
